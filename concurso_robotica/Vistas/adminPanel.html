<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - Concurso de Robótica</title>
    
    <!-- Tailwind CSS (Utilidades) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Hoja de Estilos Personalizada -->
    <link rel="stylesheet" href="../Diseño/admin_styles.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
</head>
    <!-- HEADER SUPERIOR -->
    <header class="bg-gradient-to-r from-[#52C5CB] to-[#5852CB] text-white shadow-lg z-10 shrink-0">
        <div class="container mx-auto px-6 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-white/20 p-2 rounded-lg backdrop-blur-sm">
                    <i class="fa-solid fa-screwdriver-wrench text-xl"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold tracking-wide">PANEL DE ADMINISTRACIÓN</h1>
                    <p class="text-xs text-white/80">Sistema de Gestión de Concurso</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="text-right hidden md:block">
                    <p class="text-sm font-semibold" id="adminName">Cargando...</p>
                    <p class="text-xs text-green-200"><i class="fa-solid fa-circle text-[8px] mr-1"></i>En línea</p>
                </div>
                <!-- Botón Header (Opcional, ya que agregamos el grande en el sidebar) -->
                <button onclick="handleLogout()" class="md:hidden bg-white/10 hover:bg-white/20 text-white px-3 py-2 rounded-lg transition-colors text-sm font-medium">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="flex flex-1 overflow-hidden">
        
        <!-- SIDEBAR -->
        <nav class="w-64 bg-white border-r border-gray-200 flex flex-col shrink-0 hidden md:flex">
            <div class="p-6">
                <p class="text-xs font-bold text-gray-400 uppercase mb-4 tracking-wider">Menú Principal</p>
                <div class="space-y-2">
                    <button onclick="switchTab('dashboard')" id="nav-dashboard" class="w-full text-left px-4 py-3 rounded-xl bg-gray-50 text-[#5289CB] font-bold border-l-4 border-[#5289CB] shadow-sm transition-all flex items-center gap-3">
                        <i class="fa-solid fa-chart-pie w-5"></i> Dashboard
                    </button>
                    <button onclick="switchTab('eventos')" id="nav-eventos" class="w-full text-left px-4 py-3 rounded-xl text-gray-500 hover:bg-gray-50 hover:text-gray-700 transition-all flex items-center gap-3">
                        <i class="fa-solid fa-calendar-check w-5"></i> Gestión de Eventos
                    </button>
                    <button onclick="mostrarNotificacion('Reportes disponibles en versión completa', 'info')" class="w-full text-left px-4 py-3 rounded-xl text-gray-500 hover:bg-gray-50 hover:text-gray-700 transition-all flex items-center gap-3">
                        <i class="fa-solid fa-file-pdf w-5"></i> Reportes
                    </button>
                </div>
            </div>
            
            <!-- SECCIÓN INFERIOR EDITADA: BOTÓN DE SALIR -->
            <div class="mt-auto p-6 border-t border-gray-100">
                <button onclick="handleLogout()" class="w-full bg-red-50 hover:bg-red-100 text-red-600 font-bold py-3 px-4 rounded-xl transition-colors flex items-center justify-center gap-2 border border-red-200 shadow-sm group">
                    <i class="fa-solid fa-power-off group-hover:scale-110 transition-transform"></i>
                    <span>Cerrar Sesión</span>
                </button>
            </div>
        </nav>

        <!-- AREA DE CONTENIDO -->
        <main class="flex-1 overflow-y-auto bg-[#f8f9fa] p-4 md:p-8 relative">
            
            <!-- Toast Notification -->
            <div id="toast" class="fixed top-20 right-5 transform translate-x-full transition-transform duration-300 z-50 bg-white border-l-4 border-green-500 shadow-xl rounded-lg p-4 flex items-center gap-3 min-w-[300px]">
                <div class="text-green-500 text-xl"><i class="fa-solid fa-circle-check"></i></div>
                <div>
                    <h4 class="font-bold text-sm text-gray-800" id="toastTitle">Éxito</h4>
                    <p class="text-xs text-gray-500" id="toastMessage">Operación realizada</p>
                </div>
            </div>

            <!-- TAB: DASHBOARD -->
            <div id="tab-dashboard" class="animate-fade-in space-y-6">
                <div class="flex justify-between items-end mb-2">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Resumen General</h2>
                        <p class="text-sm text-gray-500">Vista rápida de las métricas del sistema.</p>
                    </div>
                    <button onclick="cargarEstadisticas()" class="text-[#5289CB] text-sm hover:underline"><i class="fa-solid fa-rotate-right mr-1"></i> Actualizar</button>
                </div>

                <!-- Tarjetas Estadísticas -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4 hover:shadow-md transition-shadow">
                        <div class="w-12 h-12 rounded-full bg-purple-100 flex items-center justify-center text-[#5852CB] text-xl">
                            <i class="fa-solid fa-calendar-days"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Eventos Activos</p>
                            <h3 class="text-3xl font-bold text-gray-800" id="statEventos">-</h3>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4 hover:shadow-md transition-shadow">
                        <div class="w-12 h-12 rounded-full bg-teal-100 flex items-center justify-center text-[#52C5CB] text-xl">
                            <i class="fa-solid fa-users-gear"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Equipos Registrados</p>
                            <h3 class="text-3xl font-bold text-gray-800" id="statEquipos">-</h3>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4 hover:shadow-md transition-shadow">
                        <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-500 text-xl">
                            <i class="fa-solid fa-user-check"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Usuarios Totales</p>
                            <h3 class="text-3xl font-bold text-gray-800" id="statUsuarios">-</h3>
                        </div>
                    </div>
                </div>

                <!-- Acciones Rápidas -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                    <h3 class="font-bold text-gray-700 mb-4 text-lg">Accesos Directos</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onclick="switchTab('eventos')" class="p-4 border border-gray-200 rounded-xl hover:bg-gray-50 transition flex items-center gap-4 group text-left">
                            <div class="bg-gradient-to-r from-[#52C5CB] to-[#5289CB] w-10 h-10 rounded-lg flex items-center justify-center text-white shadow-md group-hover:scale-110 transition-transform">
                                <i class="fa-solid fa-plus"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-700">Gestionar Evento</h4>
                                <p class="text-xs text-gray-500">Crear nuevo o editar existentes</p>
                            </div>
                        </button>
                        <button onclick="switchTab('eventos'); setTimeout(() => document.getElementById('section-promocion').scrollIntoView({behavior: 'smooth'}), 300);" class="p-4 border border-gray-200 rounded-xl hover:bg-gray-50 transition flex items-center gap-4 group text-left">
                            <div class="bg-gradient-to-r from-[#5289CB] to-[#5852CB] w-10 h-10 rounded-lg flex items-center justify-center text-white shadow-md group-hover:scale-110 transition-transform">
                                <i class="fa-solid fa-user-graduate"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-700">Promover Juez</h4>
                                <p class="text-xs text-gray-500">Otorgar permisos a coaches</p>
                            </div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- TAB: GESTIÓN DE EVENTOS -->
            <div id="tab-eventos" class="hidden space-y-8 animate-fade-in pb-10">
                
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Gestión de Eventos</h2>
                        <p class="text-sm text-gray-500">Administra competencias y asignaciones.</p>
                    </div>
                </div>

                <!-- SECCIÓN 1: CONTROL DE EVENTOS -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                    <div class="p-5 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <h3 class="font-bold text-[#5289CB] flex items-center gap-2">
                            <i class="fa-solid fa-trophy"></i> 1. Selección de Evento
                        </h3>
                        <button onclick="toggleSection('createEventForm')" class="text-xs bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded transition">
                            <i class="fa-solid fa-plus"></i> Nuevo
                        </button>
                    </div>
                    
                    <div class="p-6">
                        <div class="flex flex-col md:flex-row gap-4 items-end mb-6">
                            <div class="flex-1 w-full">
                                <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Evento Activo</label>
                                <select id="eventoSelector" onchange="cargarDetalleEvento()" class="w-full border-gray-300 border rounded-lg p-3 focus:ring-2 focus:ring-[#52C5CB] focus:border-[#52C5CB] outline-none bg-gray-50">
                                    <option value="" disabled selected>-- Seleccione un evento --</option>
                                </select>
                            </div>
                            <button onclick="eliminarEvento()" id="btnEliminarEvento" class="bg-red-100 text-red-600 hover:bg-red-200 px-4 py-3 rounded-lg font-bold transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <i class="fa-solid fa-trash-can mr-2"></i> Eliminar
                            </button>
                        </div>

                        <div id="createEventForm" class="hidden bg-[#e8f4f8] rounded-xl p-5 border border-blue-100 space-y-4 relative">
                            <button onclick="toggleSection('createEventForm')" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
                            <h4 class="font-bold text-sm text-gray-700">Crear Nuevo Evento</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <input type="text" id="newEventoNombre" placeholder="Nombre (ej. Torneo Nacional)" class="border rounded-lg p-2 text-sm w-full">
                                <input type="date" id="newEventoFecha" class="border rounded-lg p-2 text-sm w-full">
                                <input type="text" id="newEventoLugar" placeholder="Lugar (ej. Auditorio)" class="border rounded-lg p-2 text-sm w-full">
                            </div>
                            <div class="text-right">
                                <button onclick="crearEvento()" class="bg-[#27ae60] hover:bg-green-600 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-md transition">
                                    Guardar Evento
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN 2: ASIGNACIÓN DE JUECES -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden opacity-50 pointer-events-none transition-all duration-300" id="panelAsignacion">
                    <div class="p-5 border-b border-gray-100 bg-gray-50">
                        <h3 class="font-bold text-[#5289CB] flex items-center gap-2">
                            <i class="fa-solid fa-gavel"></i> 2. Asignación de Jueces
                        </h3>
                    </div>
                    
                    <div class="p-6 grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                <h4 class="font-bold text-sm text-blue-800 mb-3">Asignar Nuevo Juez</h4>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 mb-1">Juez Disponible</label>
                                        <select id="juezSelector" class="w-full border rounded-lg p-2 text-sm bg-white">
                                            <option value="">Cargando jueces...</option>
                                        </select>
                                        <p class="text-[10px] text-gray-400 mt-1 italic">* Solo muestra usuarios con rol JUEZ o COACH_JUEZ</p>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 mb-1">Categoría a Evaluar</label>
                                        <select id="categoriaSelector" class="w-full border rounded-lg p-2 text-sm bg-white">
                                            <option value="PRIMARIA">PRIMARIA</option>
                                            <option value="SECUNDARIA">SECUNDARIA</option>
                                            <option value="PREPARATORIA">PREPARATORIA</option>
                                            <option value="UNIVERSIDAD">UNIVERSIDAD</option>
                                        </select>
                                    </div>
                                    <button onclick="asignarJuez()" class="w-full bg-gradient-to-r from-[#5289CB] to-[#5852CB] text-white py-2 rounded-lg font-bold shadow-md mt-2 hover:opacity-90">
                                        <i class="fa-solid fa-plus-circle mr-1"></i> Asignar al Evento
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-col h-full">
                            <h4 class="font-bold text-sm text-gray-700 mb-2 flex justify-between">
                                <span>Jueces Asignados Actualmente</span>
                                <span class="text-xs bg-gray-200 px-2 py-0.5 rounded-full text-gray-600" id="countJueces">0</span>
                            </h4>
                            <div class="flex-1 border rounded-xl overflow-hidden bg-gray-50 relative min-h-[200px]">
                                <div class="overflow-y-auto max-h-[300px]">
                                    <table class="w-full text-sm text-left">
                                        <thead class="text-xs text-gray-500 uppercase bg-gray-100 sticky top-0">
                                            <tr>
                                                <th class="px-4 py-3">Juez</th>
                                                <th class="px-4 py-3">Categoría</th>
                                                <th class="px-4 py-3 text-center">Acción</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tablaAsignaciones" class="divide-y divide-gray-200 bg-white">
                                            <tr>
                                                <td colspan="3" class="px-4 py-8 text-center text-gray-400 italic">
                                                    Seleccione un evento para ver asignaciones
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN 3: PROMOCIÓN (Usuario Híbrido) -->
                <div id="section-promocion" class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                    <div class="p-5 border-b border-gray-100 bg-gray-50">
                        <h3 class="font-bold text-[#5289CB] flex items-center gap-2">
                            <i class="fa-solid fa-user-shield"></i> 3. Promoción de Personal (Coaches)
                        </h3>
                    </div>
                    
                    <div class="p-6">
                        <div class="flex items-start gap-4 mb-4 bg-yellow-50 p-3 rounded-lg border border-yellow-100">
                            <i class="fa-solid fa-triangle-exclamation text-yellow-500 mt-1"></i>
                            <div class="text-sm text-yellow-800">
                                <p class="font-bold">Información sobre el Doble Rol</p>
                                <p class="text-xs opacity-90">Al promover a un Coach, este obtendrá el rol "COACH_JUEZ". Podrá seguir administrando sus equipos pero también tendrá permiso para evaluar proyectos en categorías donde no tenga conflicto de interés.</p>
                            </div>
                        </div>

                        <div class="overflow-x-auto border rounded-xl">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-gray-500 uppercase bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3">Nombre Coach</th>
                                        <th class="px-6 py-3">Email</th>
                                        <th class="px-6 py-3">Institución</th>
                                        <th class="px-6 py-3 text-center">Acción</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaCoaches" class="divide-y divide-gray-200 bg-white">
                                    <!-- Filas dinámicas -->
                                </tbody>
                            </table>
                        </div>
                        <div id="emptyCoaches" class="hidden p-8 text-center text-gray-400 italic">
                            No hay coaches disponibles para promoción.
                        </div>
                    </div>
                </div>

            </div>

        </main>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(new URLSearchParams(window.location.search).get('firebaseConfig') || '{}');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'default-app-id';

        let currentUser = null;
        let currentEventId = null;
        let eventUnsubscribe = null;
        let judgesUnsubscribe = null;
        let coachesUnsubscribe = null;
        let assignUnsubscribe = null;

        async function initAuth() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('authOverlay').classList.add('hidden');
                    document.getElementById('adminName').innerText = "Administrador";
                    loadStats();
                    loadEvents();
                    loadJudges();
                    loadCoaches();
                } else {
                    document.getElementById('authOverlay').classList.remove('hidden');
                    signInAnonymously(auth).catch((error) => {
                        console.error("Error Auth:", error);
                        // No mostrar alerta intrusiva en demo
                    });
                }
            });
        }
        initAuth();

        window.handleLogout = () => {
            // Cierra sesión en Firebase y luego redirige al login
            signOut(auth).then(() => {
                window.location.href = 'login.html';
            });
        };

        function loadStats() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'events'), (snapshot) => {
                const active = snapshot.docs.filter(d => d.data().activo !== false).length;
                document.getElementById('statEventos').innerText = active;
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (snapshot) => {
                const total = snapshot.size; 
                document.getElementById('statUsuarios').innerText = total;
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'teams'), (snapshot) => {
                document.getElementById('statEquipos').innerText = snapshot.size;
            }, (error) => {
                document.getElementById('statEquipos').innerText = "0";
            });
        }

        function loadEvents() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'events'));
            
            eventUnsubscribe = onSnapshot(q, (snapshot) => {
                const select = document.getElementById('eventoSelector');
                const currentVal = select.value;
                
                select.innerHTML = '<option value="" disabled selected>-- Seleccione un evento --</option>';
                
                const events = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.activo !== false) {
                        events.push({ id: doc.id, ...data });
                    }
                });

                events.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

                events.forEach(evt => {
                    const opt = document.createElement('option');
                    opt.value = evt.id;
                    opt.text = `${evt.nombre} (${evt.fecha})`;
                    select.appendChild(opt);
                });

                if (currentVal && events.find(e => e.id === currentVal)) {
                    select.value = currentVal;
                } else if (currentEventId) {
                    resetPanelAsignacion();
                }
            });
        }

        window.crearEvento = async () => {
            const nombre = document.getElementById('newEventoNombre').value.trim();
            const fecha = document.getElementById('newEventoFecha').value;
            const lugar = document.getElementById('newEventoLugar').value.trim();

            if(!nombre || !fecha || !lugar) {
                mostrarNotificacion("Complete todos los campos", "error");
                return;
            }

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'events'), {
                    nombre: nombre,
                    fecha: fecha,
                    lugar: lugar,
                    activo: true,
                    createdAt: new Date().toISOString()
                });
                mostrarNotificacion("Evento creado exitosamente", "success");
                document.getElementById('newEventoNombre').value = "";
                document.getElementById('newEventoLugar').value = "";
                toggleSection('createEventForm');
            } catch (e) {
                mostrarNotificacion("Error al crear: " + e.message, "error");
            }
        };

        window.eliminarEvento = async () => {
            if(!currentEventId) return;
            // Usamos un modal propio o confirm simple por limitación de iframe, pero preferible confirm para admin
            if(!confirm("¿Está seguro de eliminar este evento? Esta acción no se puede deshacer.")) return;

            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'events', currentEventId);
                await updateDoc(docRef, { activo: false });
                mostrarNotificacion("Evento eliminado", "success");
                resetPanelAsignacion();
            } catch (e) {
                mostrarNotificacion("Error: " + e.message, "error");
            }
        };

        window.cargarDetalleEvento = () => {
            const select = document.getElementById('eventoSelector');
            currentEventId = select.value;
            
            if (currentEventId) {
                document.getElementById('btnEliminarEvento').disabled = false;
                const panel = document.getElementById('panelAsignacion');
                panel.classList.remove('opacity-50', 'pointer-events-none');
                cargarAsignaciones(currentEventId);
            }
        };

        function resetPanelAsignacion() {
            currentEventId = null;
            document.getElementById('eventoSelector').value = "";
            document.getElementById('btnEliminarEvento').disabled = true;
            document.getElementById('panelAsignacion').classList.add('opacity-50', 'pointer-events-none');
            document.getElementById('tablaAsignaciones').innerHTML = '<tr><td colspan="3" class="px-4 py-8 text-center text-gray-400 italic">Seleccione un evento</td></tr>';
            document.getElementById('countJueces').innerText = "0";
        }

        function loadJudges() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (snapshot) => {
                const select = document.getElementById('juezSelector');
                select.innerHTML = '<option value="">-- Seleccione Juez --</option>';
                
                snapshot.forEach(doc => {
                    const u = doc.data();
                    if (u.role === 'JUEZ' || u.role === 'COACH_JUEZ') {
                        const opt = document.createElement('option');
                        opt.value = doc.id;
                        opt.text = `${u.nombres} ${u.apellidos} (${u.role === 'COACH_JUEZ' ? 'Híbrido' : 'Juez'})`;
                        opt.setAttribute('data-name', `${u.nombres} ${u.apellidos}`);
                        opt.setAttribute('data-school', u.escuela_proc || "");
                        select.appendChild(opt);
                    }
                });
            });
        }

        function cargarAsignaciones(eventId) {
            if(assignUnsubscribe) assignUnsubscribe();

            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'assignments'));
            
            assignUnsubscribe = onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById('tablaAsignaciones');
                tbody.innerHTML = '';
                
                let count = 0;
                const assignments = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if(data.eventId === eventId) {
                        assignments.push({id: doc.id, ...data});
                    }
                });

                assignments.sort((a, b) => a.category.localeCompare(b.category));

                if (assignments.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="px-4 py-4 text-center text-gray-400 text-xs">Sin jueces asignados</td></tr>';
                }

                assignments.forEach(asg => {
                    count++;
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 transition-colors";
                    tr.innerHTML = `
                        <td class="px-4 py-3 font-medium text-gray-700">${asg.judgeName}</td>
                        <td class="px-4 py-3"><span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full font-bold">${asg.category}</span></td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="removerJuez('${asg.id}')" class="text-red-400 hover:text-red-600 transition">
                                <i class="fa-solid fa-circle-xmark text-lg"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                
                document.getElementById('countJueces').innerText = count;
            });
        }

        window.asignarJuez = async () => {
            if(!currentEventId) return;
            
            const juezSelect = document.getElementById('juezSelector');
            const judgeId = juezSelect.value;
            const category = document.getElementById('categoriaSelector').value;
            
            if(!judgeId) {
                mostrarNotificacion("Seleccione un juez", "error");
                return;
            }

            const judgeName = juezSelect.options[juezSelect.selectedIndex].getAttribute('data-name');
            const judgeSchool = juezSelect.options[juezSelect.selectedIndex].getAttribute('data-school');

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'assignments'), {
                    eventId: currentEventId,
                    judgeId: judgeId,
                    judgeName: judgeName,
                    category: category,
                    assignedAt: new Date().toISOString()
                });
                
                mostrarNotificacion("Juez asignado correctamente", "success");
            } catch (e) {
                mostrarNotificacion("Error: " + e.message, "error");
            }
        };

        window.removerJuez = async (assignmentId) => {
            if(!confirm("¿Quitar juez de este evento?")) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'assignments', assignmentId));
                mostrarNotificacion("Asignación removida", "success");
            } catch (e) {
                mostrarNotificacion("Error: " + e.message, "error");
            }
        };

        function loadCoaches() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'));
            
            coachesUnsubscribe = onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById('tablaCoaches');
                const emptyMsg = document.getElementById('emptyCoaches');
                tbody.innerHTML = '';
                
                let hasCoaches = false;

                snapshot.forEach(doc => {
                    const u = doc.data();
                    if (u.role === 'COACH') {
                        hasCoaches = true;
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="px-6 py-4 font-bold text-gray-700">${u.nombres} ${u.apellidos}</td>
                            <td class="px-6 py-4 text-gray-500">${u.email}</td>
                            <td class="px-6 py-4 text-gray-500">${u.escuela_proc || 'N/A'}</td>
                            <td class="px-6 py-4 text-center">
                                <button onclick="promoverCoach('${doc.id}', '${u.nombres}')" class="bg-yellow-100 hover:bg-yellow-200 text-yellow-700 font-bold py-1 px-3 rounded-lg text-xs transition border border-yellow-300">
                                    <i class="fa-solid fa-star mr-1"></i> Hacer Juez
                                </button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    }
                });

                if (hasCoaches) {
                    emptyMsg.classList.add('hidden');
                    tbody.classList.remove('hidden');
                } else {
                    emptyMsg.classList.remove('hidden');
                    tbody.classList.add('hidden');
                }
            });
        }

        window.promoverCoach = async (uid, nombre) => {
            if(!confirm(`¿Desea promover a ${nombre} al rol de COACH_JUEZ?`)) return;
            
            try {
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', uid);
                await updateDoc(userRef, { role: 'COACH_JUEZ' });
                mostrarNotificacion("Usuario promovido exitosamente", "success");
            } catch(e) {
                mostrarNotificacion("Error: " + e.message, "error");
            }
        };

        window.switchTab = (tabId) => {
            document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('[id^="nav-"]').forEach(el => {
                el.classList.remove('bg-gray-50', 'text-[#5289CB]', 'font-bold', 'border-l-4', 'border-[#5289CB]', 'shadow-sm');
                el.classList.add('text-gray-500');
            });

            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            
            const activeNav = document.getElementById(`nav-${tabId}`);
            activeNav.classList.remove('text-gray-500');
            activeNav.classList.add('bg-gray-50', 'text-[#5289CB]', 'font-bold', 'border-l-4', 'border-[#5289CB]', 'shadow-sm');
        };

        window.toggleSection = (id) => {
            const el = document.getElementById(id);
            if (el.classList.contains('hidden')) {
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        };

        window.mostrarNotificacion = (msg, type) => {
            const toast = document.getElementById('toast');
            const title = document.getElementById('toastTitle');
            const message = document.getElementById('toastMessage');
            
            title.innerText = type === 'success' ? 'Éxito' : (type === 'error' ? 'Error' : 'Información');
            message.innerText = msg;
            
            toast.className = `fixed top-20 right-5 transform transition-transform duration-300 z-50 bg-white border-l-4 shadow-xl rounded-lg p-4 flex items-center gap-3 min-w-[300px] ${
                type === 'success' ? 'border-green-500' : (type === 'error' ? 'border-red-500' : 'border-blue-500')
            }`;
            
            toast.querySelector('div').className = `text-xl ${
                type === 'success' ? 'text-green-500' : (type === 'error' ? 'text-red-500' : 'text-blue-500')
            }`;
            toast.querySelector('i').className = type === 'success' ? 'fa-solid fa-circle-check' : (type === 'error' ? 'fa-solid fa-circle-xmark' : 'fa-solid fa-circle-info');

            toast.classList.remove('translate-x-full');
            
            setTimeout(() => {
                toast.classList.add('translate-x-full');
            }, 3000);
        };

        switchTab('dashboard');
    </script>
</body>
</html>